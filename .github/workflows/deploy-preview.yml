name: Deploy Preview

on:
  pull_request:
    branches: [main]

concurrency:
  group: preview-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-preview:
    name: Deploy Preview to Cloudflare Pages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate manifests
        run: npm run validate:manifests

      - name: Generate manifests and metadata
        run: |
          npm run generate:manifests
          npm run generate:metadata

      - name: Build with OpenNext
        run: npm run build
        env:
          BUILD_TIME: ${{ github.event.pull_request.updated_at }}

      # TODO: Configure Cloudflare Pages deployment
      # You'll need to add these secrets to your repository:
      # - CLOUDFLARE_API_TOKEN
      # - CLOUDFLARE_ACCOUNT_ID
      #
      # Uncomment the steps below after adding the secrets:
      #
      # - name: Deploy to Cloudflare Pages (Preview)
      #   id: deploy
      #   uses: cloudflare/wrangler-action@v3
      #   with:
      #     apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      #     accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      #     command: pages deploy .open-next --project-name=aicodingstack --branch=preview-${{ github.event.pull_request.number }}
      #
      # - name: Comment preview URL
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const previewUrl = '${{ steps.deploy.outputs.deployment-url }}';
      #       const comment = `## üöÄ Preview Deployment
      #
      #       Preview is ready!
      #
      #       **Preview URL:** ${previewUrl}
      #
      #       ### Build Details
      #       - **Commit:** ${context.sha.substring(0, 7)}
      #       - **Build Time:** ${{ github.event.pull_request.updated_at }}
      #
      #       The preview will be automatically deleted when this PR is merged or closed.`;
      #
      #       github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: comment
      #       });

      - name: Preview deployment placeholder
        run: |
          echo "‚ö†Ô∏è  Preview deployment not yet configured"
          echo "To enable preview deployments:"
          echo "1. Add CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID to repository secrets"
          echo "2. Uncomment the deployment steps in .github/workflows/deploy-preview.yml"

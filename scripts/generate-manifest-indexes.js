#!/usr/bin/env node

/**
 * Generate Manifest Index Files
 *
 * This script automatically generates TypeScript index files for each manifest type.
 * It scans the manifests directory and creates aggregated exports in src/lib/manifests/
 *
 * Usage: node scripts/generate-manifest-indexes.js
 */

const fs = require('fs');
const path = require('path');

const MANIFESTS_DIR = path.join(__dirname, '../manifests');
const OUTPUT_DIR = path.join(__dirname, '../src/lib/generated');

// Manifest types to process
const MANIFEST_TYPES = [
  'ides',
  'clis',
  'models',
  'providers',
  'extensions',
  'vendors'
];

/**
 * Ensure directory exists
 */
function ensureDir(dirPath) {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
    console.log(`‚úì Created directory: ${dirPath}`);
  }
}

/**
 * Convert kebab-case id to PascalCase variable name
 */
function toPascalCase(str) {
  return str
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join('');
}

/**
 * Get all JSON files in a directory
 */
function getJsonFiles(dirPath) {
  if (!fs.existsSync(dirPath)) {
    return [];
  }
  return fs.readdirSync(dirPath)
    .filter(file => file.endsWith('.json'))
    .sort();
}

/**
 * Generate index file for a manifest type
 */
function generateIndexFile(typeName) {
  const typeDir = path.join(MANIFESTS_DIR, typeName);
  const files = getJsonFiles(typeDir);

  if (files.length === 0) {
    console.log(`‚ö† No JSON files found in ${typeName}/`);
    return;
  }

  // Generate import statements
  const imports = files.map(file => {
    const id = file.replace('.json', '');
    const varName = toPascalCase(id);
    const relativePath = `../../../manifests/${typeName}/${file}`;
    return `import ${varName} from '${relativePath}';`;
  }).join('\n');

  // Generate array export
  const arrayItems = files.map(file => {
    const id = file.replace('.json', '');
    return toPascalCase(id);
  }).join(',\n  ');

  // Generate type name (singular)
  const typeSingular = typeName.replace(/s$/, '');
  const TypeName = toPascalCase(typeSingular);

  // Get the first file to extract type
  const firstFile = files[0].replace('.json', '');
  const firstVarName = toPascalCase(firstFile);

  const content = `/**
 * Auto-generated manifest index for ${typeName}
 * Generated by scripts/generate-manifest-indexes.js
 * Do not edit manually - run the script to regenerate
 */

${imports}

export const ${typeName}Data = [
  ${arrayItems}
];

export type ${TypeName} = typeof ${firstVarName};

export default ${typeName}Data;
`;

  const outputPath = path.join(OUTPUT_DIR, `${typeName}.ts`);
  fs.writeFileSync(outputPath, content, 'utf8');
  console.log(`‚úì Generated ${typeName}.ts (${files.length} entries)`);
}

/**
 * Generate main index.ts file that exports all manifests
 */
function generateMainIndex() {
  const exports = MANIFEST_TYPES.map(typeName => {
    return `export { ${typeName}Data } from './${typeName}';
export type { ${toPascalCase(typeName.replace(/s$/, ''))} } from './${typeName}';`;
  }).join('\n');

  const content = `/**
 * Auto-generated main manifest index
 * Generated by scripts/generate-manifest-indexes.js
 * Do not edit manually - run the script to regenerate
 */

${exports}
`;

  const outputPath = path.join(OUTPUT_DIR, 'index.ts');
  fs.writeFileSync(outputPath, content, 'utf8');
  console.log(`‚úì Generated index.ts`);
}

/**
 * Main execution
 */
function main() {
  console.log('='.repeat(60));
  console.log('Generate Manifest Index Files');
  console.log('='.repeat(60));

  // Ensure output directory exists
  ensureDir(OUTPUT_DIR);

  console.log('\nüìù Generating index files...\n');

  // Generate index file for each type
  for (const typeName of MANIFEST_TYPES) {
    generateIndexFile(typeName);
  }

  // Generate main index
  console.log('');
  generateMainIndex();

  console.log('\n' + '='.repeat(60));
  console.log('‚úÖ All index files generated successfully!');
  console.log('='.repeat(60));
}

// Run the script
try {
  main();
} catch (error) {
  console.error('\n‚ùå Error generating index files:', error.message);
  console.error(error.stack);
  process.exit(1);
}
